# 충암고 가상 주식 투자

충암고등학교 학생들을 위한 실전 같은 가상 주식 투자 시뮬레이션 웹사이트

## 프로젝트 개요

- **프로젝트명**: 충암고 가상 주식 투자
- **목적**: 학생들이 주식 투자를 실전처럼 체험하고 경제 개념을 학습
- **기술 스택**: Hono + TypeScript + Cloudflare D1 + TailwindCSS

## 접속 URL

- **개발 서버**: https://3000-i09kixs4q6553irtu5s6b-583b4d74.sandbox.novita.ai
- **메인 페이지**: `/`
- **학생 페이지**: `/student`
- **관리자 페이지**: `/admin`

## 완료된 기능

### 1. 학생/교사 기능
- ✅ 학번/교사ID 기반 로그인 (회원가입 불필요)
- ✅ **학생 750명 자동 생성** (1학년 1~12반 360명 + 2학년 1~13반 390명)
- ✅ 교사 90명 자동 생성 (t001 ~ t090)
- ✅ 초기 자금 100만원 자동 지급
- ✅ 초기 비밀번호: 1111 (학생/교사 공통)
- ✅ **최초 로그인 시 비밀번호 변경 필수**
- ✅ 8개 주식 종목 실시간 거래 (매수/매도)
- ✅ **거래량 기반 자동 주가 변동 시스템**
- ✅ **거래 시간 제한** (08:00-16:00, 8개 거래 시간대)
- ✅ 포트폴리오 관리 (보유 주식, 수익률 확인)
- ✅ 거래 내역 자동 저장 및 실시간 반영
- ✅ 뉴스 열람 (무료/유료 뉴스 구분)
- ✅ 유료 뉴스 구매 시스템
- ✅ 투자 랭킹 (평가 금액 기준 순위)
- ✅ **주식별 가격 변동 차트**

### 2. 관리자 기능
- ✅ 관리자 로그인 (ID: cham001, PW: cjstmdgh-01)
- ✅ **24시간 주가 변경 가능**
  - 거래 시간 중: 변경 즉시 모든 사용자에게 실시간 반영
  - 거래 시간 외: 예약 저장 → 다음 거래 시간에 자동 반영
- ✅ **실시간 주가 업데이트 알림** (즉시 반영/예약 상태 표시)
- ✅ 주가 변동 이력 자동 저장
- ✅ 뉴스 작성 (일반/고급 뉴스)
- ✅ 고급 뉴스 가격 설정
- ✅ 뉴스 삭제
- ✅ 사용자 관리 및 순위 확인
- ✅ **거래 시간별 거래량 조회**

### 3. 주식 종목
- ✅ 충암 전자 (CA001) - 초기가: 50,000원
- ✅ 충암 반도체 (CA002) - 초기가: 75,000원
- ✅ 충암 항공 (CA003) - 초기가: 30,000원
- ✅ 충암 자동차 (CA004) - 초기가: 45,000원
- ✅ 충암 바이오 (CA005) - 초기가: 60,000원
- ✅ 충암 화학 (CA006) - 초기가: 35,000원
- ✅ 충암 식품 (CA007) - 초기가: 25,000원
- ✅ 충암 미디어 (CA008) - 초기가: 40,000원

## 데이터 구조

### 데이터베이스 스키마 (Cloudflare D1)

1. **users**: 학생 + 교사 사용자 정보
   - id, username, password, name, user_type, cash, password_changed
   
2. **admins**: 관리자 정보
   - id, username, password
   
3. **stocks**: 주식 종목 정보
   - id, code, name, current_price
   
4. **user_stocks**: 사용자 주식 보유 정보
   - user_id, stock_id, quantity, avg_price
   
5. **transactions**: 거래 내역
   - user_id, stock_id, type (BUY/SELL), quantity, price, total_amount
   
6. **trading_volume**: 거래 시간대별 거래량 집계
   - stock_id, time_window, buy_volume, sell_volume, net_volume, price_before, price_after
   
7. **price_impact_settings**: 주가 영향 설정
   - stock_id, impact_rate, max_change_rate, min_volume
   
8. **pending_price_updates**: 예약된 주가 변경
   - stock_id, new_price, changed_by, status, applied_at
   
9. **news**: 뉴스 정보
   - id, title, content, type (FREE/PREMIUM), price
   
10. **news_views**: 뉴스 열람 기록
    - user_id, news_id
   
11. **price_history**: 주가 변동 이력
    - stock_id, price, changed_by

## 사용자 가이드

### 학생/교사 이용 방법

1. **로그인**
   - 메인 페이지에서 "학생" 클릭
   - 학번 또는 교사ID 입력
   - 비밀번호 입력 (초기 비밀번호: 1111)
   - **최초 로그인 시 비밀번호 변경 화면이 자동으로 나타남**
   - 비밀번호 변경 후 시스템 사용 가능

2. **계정 정보**
   - **학생 (총 750명)**
     - 1학년 1~12반: 10101 ~ 11230 (각 반 30명씩, 총 360명)
     - 2학년 1~13반: 20101 ~ 21330 (각 반 30명씩, 총 390명)
   - **교사 (총 90명)**
     - t001 ~ t090
   - **초기 비밀번호**: 1111 (모든 계정 공통)
   - **초기 자금**: 1,000,000원

3. **비밀번호 변경**
   - 최초 로그인 시 자동으로 비밀번호 변경 화면 표시
   - 현재 비밀번호(1111) 입력
   - 새 비밀번호 입력 (최소 4자 이상)
   - 새 비밀번호 확인
   - 변경 후 메인 화면으로 이동

4. **주식 거래**
   - **거래 가능 시간**: 08:00 ~ 16:00 KST (한국 시간, 8개 거래 시간대)
     - 08:00-08:20, 09:10-09:20, 10:10-10:20, 11:10-11:20
     - 12:10-12:20, 13:00-13:10, 14:00-14:10, 15:00-15:10
   - 주식 거래 탭에서 원하는 종목 선택
   - 수량 입력 후 매수/매도 버튼 클릭
   - 잔액 확인 후 거래 완료
   - 거래 내역 자동 저장 및 실시간 반영
   - **거래 시간 종료 시 자동으로 주가 업데이트** (거래량 기반)

5. **포트폴리오 확인**
   - 내 포트폴리오 탭에서 보유 주식 확인
   - 수익률 및 평가 손익 실시간 확인
   - 거래 내역 조회 가능

6. **뉴스 열람**
   - 뉴스 탭에서 무료 뉴스 무제한 열람
   - 고급 뉴스는 설정된 금액 지불 후 열람
   - 한번 구매한 뉴스는 다시 볼 수 있음

7. **투자 랭킹 확인**
   - 투자 랭킹 탭에서 전체 순위 확인
   - 평가 금액 (총 자산) = 현금 + 주식 평가액 기준
   - 실시간 순위 업데이트

### 관리자 이용 방법

1. **로그인**
   - ID: `cham001`
   - PW: `cjstmdgh-01`

2. **주가 조정**
   - **24시간 언제든지 주가 변경 가능 (모든 시간은 한국 시간 KST 기준)**
   - **거래 시간 중 (08:00-16:00 KST)**:
     - ✅ 일반 버튼: 변경 즉시 모든 사용자에게 실시간 반영
     - ⚡ 즉시 반영 버튼: 거래 시간 관계없이 강제로 즉시 반영
     - 헤더에 "즉시 반영" 상태 표시 (초록색)
     - 확인 메시지: "주가가 즉시 반영되었습니다!"
   - **거래 시간 외**:
     - 일반 버튼: ⏰ 예약으로 저장 → 다음 거래 시간에 자동 반영
     - ⚡ 즉시 반영 버튼: 거래 시간 관계없이 강제로 즉시 반영 (비상용)
     - 헤더에 "예약 반영" 상태 표시 (노란색)
     - 예약 시 확인 메시지: "주가 변경이 예약되었습니다!"
     - 강제 반영 시 확인 메시지: "주가가 강제로 즉시 반영되었습니다!"
   - 주가 변동 이력 자동 저장 (강제 반영 시 "(강제 반영)" 표시)
   - **학생 거래량에 따라 주가 자동 변동**
     - 순거래량(매수-매도)에 따라 가격 상승/하락
     - 100주당 약 1% 변동 (설정 가능)
     - 최대 5% 변동률 제한 (설정 가능)

3. **뉴스 작성**
   - 뉴스 관리 탭에서 "뉴스 작성" 클릭
   - 제목, 내용 입력
   - 일반(무료) 또는 고급(유료) 선택
   - 고급 뉴스는 가격 설정 (기본 50,000원)
   - 작성 완료 후 학생들에게 즉시 공개

4. **사용자 관리**
   - 사용자 관리 탭에서 전체 학생 현황 확인
   - 현금, 주식 가치, 총 자산 순위 조회

## ⏰ 시간 기준 (중요!)

**모든 시간은 한국 표준시(KST, UTC+9) 기준입니다:**
- 거래 시간: 08:00-16:00 KST
- 베타 테스트 종료: 2024-11-16 20:00 KST
- 거래 시간대 8개 모두 KST 기준
- 주가 업데이트 카운트다운: KST 기준
- API 응답의 currentTime: KST 기준

서버가 다른 시간대에 배포되어도 자동으로 한국 시간으로 변환되어 처리됩니다.

## 🔒 서버 안정성

**자동 복구 시스템 (PM2)**:
- ✅ **자동 재시작**: 크래시 시 자동으로 재시작 (최대 10회)
- ✅ **메모리 관리**: 500MB 초과 시 자동 재시작으로 메모리 누수 방지
- ✅ **에러 핸들링**: 모든 거래 API에 try-catch 구문 적용
- ✅ **최소 가동 시간**: 10초 이상 안정 가동 후에만 정상으로 간주
- ✅ **재시작 지연**: 4초 대기 후 재시작으로 즉시 재시작 방지
- ✅ **로그 관리**: 에러 로그 및 출력 로그 자동 저장

**데이터베이스 안정성 (Foreign Key 완전 처리)**:
- ✅ **외래 키 체크**: 모든 데이터 작업 전 관련 레코드 존재 확인
- ✅ **뉴스 삭제**: 구매 기록(news_views) 먼저 삭제 후 뉴스 삭제
- ✅ **거래량 집계**: 주식 존재 여부 확인 후 집계 데이터 생성
- ✅ **주가 업데이트**: 주식 존재 여부 확인 후 가격 변동 이력 저장
- ✅ **예약 주가 적용**: 실패한 예약은 'failed' 상태로 표시
- ✅ **트랜잭션 처리**: 거래 중 오류 발생 시 자동 롤백
- ✅ **에러 메시지**: 사용자 친화적인 오류 메시지 제공
- ✅ **마이그레이션 정리**: 중복 마이그레이션 파일 제거 및 데이터베이스 재구성

**최근 안정화 작업 (2025-11-10)**:
- ✅ **중복 마이그레이션 문제 해결**: 0003_trading_system.sql 제거
- ✅ **데이터베이스 완전 재구성**: trading_volume 테이블 스키마 통일
- ✅ **Foreign Key 제약 조건 완전 처리**: 모든 데이터 작업에 안전장치 추가
- ✅ **에러 핸들링 강화**: aggregateTradingVolume, updateStockPrices, apply-pending-prices 함수 보완
- ✅ **서버 크래시 문제 해결**: Foreign Key 위반 오류 완전 제거
- ✅ **테스트 완료**: 750명 학생, 8개 주식 정상 동작 확인

## 배포 상태

- ✅ 로컬 개발 환경 실행 중
- ✅ Cloudflare D1 로컬 데이터베이스 설정 완료
- ✅ PM2 자동 복구 시스템 적용
- ⏳ Cloudflare Pages 프로덕션 배포 대기

## 기술 스택

- **백엔드**: Hono (TypeScript)
- **데이터베이스**: Cloudflare D1 (SQLite)
- **프론트엔드**: HTML + TailwindCSS + Vanilla JavaScript
- **배포**: Cloudflare Pages/Workers
- **프로세스 관리**: PM2

## 개발 환경 실행

```bash
# 의존성 설치
npm install

# 빌드
npm run build

# 데이터베이스 초기화
npm run db:reset

# 개발 서버 시작 (PM2)
fuser -k 3000/tcp 2>/dev/null || true
pm2 start ecosystem.config.cjs

# 서버 상태 확인
pm2 list

# 로그 확인
pm2 logs webapp --nostream
```

## API 엔드포인트

### 인증
- `POST /api/auth/login` - 학생 로그인 (학번 기반)
- `POST /api/auth/admin-login` - 관리자 로그인

### 주식
- `GET /api/stocks` - 전체 주식 목록
- `GET /api/stocks/:id` - 주식 상세 정보
- `POST /api/stocks/:id/update-price` - 주가 업데이트 (관리자)

### 거래
- `POST /api/transactions/buy` - 주식 매수
- `POST /api/transactions/sell` - 주식 매도
- `GET /api/transactions/:userId` - 거래 내역
- `GET /api/trading-status` - 현재 거래 시간 확인
- `POST /api/update-prices-by-volume` - 거래량 기반 주가 업데이트
- `GET /api/trading-volume/current` - 현재 거래량 집계 현황
- `POST /api/apply-pending-prices` - 예약된 주가 변경 적용

### 뉴스
- `GET /api/news` - 전체 뉴스 목록
- `GET /api/news/:newsId/:userId` - 뉴스 상세 (구매 확인)
- `POST /api/news` - 뉴스 작성 (관리자)
- `POST /api/news/purchase` - 유료 뉴스 구매
- `DELETE /api/news/:newsId` - 뉴스 삭제 (관리자)

### 사용자
- `GET /api/users/:userId` - 사용자 정보
- `GET /api/users` - 전체 사용자 순위
- `GET /api/users/:userId/stocks` - 사용자 보유 주식

## 로그인 정보

### 학생 계정 (총 750명)
- **1학년 1~12반 (360명)**: 
  - 1반: 10101 ~ 10130
  - 2반: 10201 ~ 10230
  - ...
  - 12반: 11201 ~ 11230
- **2학년 1~13반 (390명)**: 
  - 1반: 20101 ~ 20130
  - 2반: 20201 ~ 20230
  - ...
  - 13반: 21301 ~ 21330
- **초기 비밀번호**: 1111 (모든 학생 공통)
- **초기 자금**: 1,000,000원
- **예시**:
  - 1학년 1반 1번: ID `10101`, PW `1111`
  - 1학년 5반 15번: ID `10515`, PW `1111`
  - 2학년 13반 30번: ID `21330`, PW `1111`

### 교사 계정 (총 90명)
- **교사 ID**: t001 ~ t090
- **초기 비밀번호**: 1111 (모든 교사 공통)
- **초기 자금**: 1,000,000원
- **예시**:
  - 교사 1: ID `t001`, PW `1111`
  - 교사 45: ID `t045`, PW `1111`
  - 교사 90: ID `t090`, PW `1111`

### 관리자 계정
- **ID**: cham001
- **PW**: cjstmdgh-01

### 중요 사항
- ⚠️ **최초 로그인 시 반드시 비밀번호를 변경해야 합니다**
- 비밀번호는 최소 4자 이상이어야 합니다
- 비밀번호 변경 후에만 주식 거래 등 시스템 이용 가능

## 프로젝트 구조

```
webapp/
├── src/
│   └── index.tsx           # Hono 백엔드 API
├── public/
│   └── static/
│       ├── student.js      # 학생 페이지 로직
│       └── admin.js        # 관리자 페이지 로직
├── migrations/
│   └── 0001_initial_schema.sql
├── seed.sql                # 초기 데이터
├── wrangler.jsonc          # Cloudflare 설정
├── ecosystem.config.cjs    # PM2 설정
└── package.json
```

## 주요 특징

### 💹 거래량 기반 자동 주가 변동 시스템
- 학생들의 매수/매도 거래량에 따라 주가가 실시간으로 변동
- **순거래량** = 매수량 - 매도량
  - 양수 (매수 우세): 주가 상승 ↑
  - 음수 (매도 우세): 주가 하락 ↓
- 거래량 100주당 약 1% 가격 변동
- 최대 5% 변동률 제한으로 급등락 방지
- 거래 시간 종료 시 자동으로 집계 및 반영

### ⏰ 거래 시간 제한
- 장 운영 시간: 08:00 ~ 16:00
- 8개 거래 시간대 (각 10~20분):
  - 오전: 08:00-08:20, 09:10-09:20, 10:10-10:20, 11:10-11:20, 12:10-12:20
  - 오후: 13:00-13:10, 14:00-14:10, 15:00-15:10
- 거래 시간 외에는 거래 불가 (실제 주식 시장과 유사)

### 📊 관리자 예약 시스템
- 관리자는 24시간 언제든지 주가 설정 가능
- 거래 시간 중: 즉시 주가 반영
- 거래 시간 외: 예약 저장 → 다음 거래 시간에 자동 반영
- 학생들에게 예약된 주가 표시

## 향후 개선 사항

- ⏳ 포인트 시스템 추가
- ⏳ 주식 토론 게시판
- ⏳ 자동 거래 알림
- ⏳ 배당금 시스템
- ⏳ 주식 분할/병합 기능
- ⏳ 주가 예측 AI 시스템

## 🎉 베타 테스트 기간 안내

### 테스트 기간: 2025년 11월 16일 (일) 오후 20:00 KST (한국 시간) 까지

**베타 기간 특별 혜택:**
- ✅ **24시간 거래 가능** - 시간 제한 없이 언제든지 주식 매수/매도
- ✅ **실시간 주가 반영** - 관리자 주가 변경 즉시 모든 사용자에게 반영
- ✅ **자유로운 테스트** - 시스템을 충분히 경험하고 버그 리포트

**정식 운영 (2025년 11월 16일 20:00 KST 이후):**
- 거래 시간 제한 적용 (08:00-16:00 KST, 8개 시간대)
- 거래량 기반 자동 주가 변동 시스템 작동
- 관리자 주가 변경은 예약 후 거래 시간에 반영
- 관리자는 "⚡ 즉시 반영" 버튼으로 긴급 주가 조정 가능

## 마지막 업데이트

- **날짜**: 2025-11-10
- **상태**: ✅ 개발 완료, **서버 안정화 완료 (Foreign Key 문제 해결)**
- **최신 업데이트 (2025-11-10 13:16 KST)**:
  - ✅ **서버 크래시 근본 원인 해결** - Foreign Key 제약 조건 위반 문제 완전 해결
  - ✅ **중복 마이그레이션 파일 제거** - trading_volume 테이블 스키마 충돌 해결
  - ✅ **데이터베이스 완전 재구성** - 로컬 D1 데이터베이스 리셋 및 마이그레이션 재적용
  - ✅ **Foreign Key 안전장치 추가** - 모든 데이터 작업에 레코드 존재 확인 로직 추가
  - ✅ **에러 핸들링 강화** - aggregateTradingVolume, updateStockPrices, apply-pending-prices 함수 보완
  - ✅ **서버 재시작 0회** - 안정적으로 동작 중, 크래시 없음
  - ✅ **테스트 완료** - 750명 학생, 8개 주식, 모든 API 정상 동작 확인
  - ✅ **서버 안정성 대폭 개선** - 자동 재시작, 메모리 관리, 에러 핸들링
  - ✅ **유료 뉴스 삭제 문제 해결** - 구매 기록과 함께 완전 삭제
  - ✅ **모바일 UI 최적화** - 헤더, 탭, 투자 랭킹 반응형 개선
  - ✅ **베타 테스트 안내 제거** - 메인/가이드 페이지 정리
  - ✅ **주가 현황판 색상 표시** - 상승(빨간색), 하락(파란색)
  - ✅ **모든 시간 기준을 한국 시간(KST, UTC+9)으로 통일**
  - ✅ **관리자 "⚡ 즉시 반영" 버튼 추가** - 거래 시간 관계없이 긴급 주가 조정
  - ✅ **베타 테스트 시스템 구현** (2025년 11월 16일 20:00 KST까지)
  - ✅ 베타 기간 24시간 거래 가능
  - ✅ 거래량 기반 자동 주가 변동 시스템 구현
  - ✅ 거래 시간 제한 시스템 (8개 거래 시간대, KST 기준)
  - ✅ 학생 계정 750명으로 확대 (1-2학년 전체)
  - ✅ 관리자 24시간 주가 예약 시스템
  - ✅ 주식 차트 자동 업데이트
  - ✅ 주가 현황판에 다음 업데이트 카운트다운 표시 (KST 기준)
